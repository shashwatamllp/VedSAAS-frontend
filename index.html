<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="ved-api-base" content="/api">
<title>VedSAAS</title>
<link rel="icon" href="/favicon.ico"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
  /* Theme vars */
  :root{
    --bg:#0e0f14; --surface:#0f1720; --muted:#94a3b8; --text:#e9edf4;
    --accent:#2a7; --panel-border:#233; --radius:10px;
  }
  .light-theme{
    --bg:#f7fafc; --surface:#ffffff; --muted:#475569; --text:#0b1220;
    --accent:#1366d6; --panel-border:#e6eef4;
  }
  :root{ color-scheme:dark }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }
  a{ color:inherit; text-decoration:none }

  /* layout */
  .container{ display:flex; min-height:100dvh }
  aside.sidebar{ width:260px; border-right:1px solid var(--panel-border); padding:12px; display:flex; flex-direction:column; gap:10px; background:var(--surface) }
  .title{ font-weight:700; margin:6px 0 8px }
  .btn{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--text); cursor:pointer }
  .btn:disabled{ opacity:.6; cursor:not-allowed }

  /* history */
  #history-list{ overflow:auto; flex:1 }
  .topic{ padding:8px 10px; border-radius:8px; cursor:pointer; color:var(--muted) }
  .topic+.topic{ margin-top:6px }
  .topic.active{ background:var(--accent); color:#fff }
  .preview{ color:var(--muted); font-size:12px; margin-top:4px }

  main{ flex:1; display:flex; flex-direction:column; min-width:0 }
  .topbar{ display:flex; justify-content:center; align-items:center; padding:10px 12px; border-bottom:1px solid var(--panel-border); background:var(--surface) }
  .topbar-inner{ width:100%; max-width:1100px; display:flex; align-items:center; justify-content:center; gap:12px; position:relative }
  .topbar h1{ margin:0; font-size:18px; letter-spacing:.5px }
  /* hard-remove any theme text in header */
  .topbar-right,.theme-text,[data-theme-indicator],#theme-toggle-btn{ display:none !important; }

  /* landing with logo bg */
  #landing{ position:relative; display:flex; flex-direction:column; gap:12px; padding:16px; min-height:40vh; overflow:hidden }
  #landing::before{ content:""; position:absolute; inset:0; background:url("/logopic.png") center/60% no-repeat; opacity:.08; pointer-events:none; z-index:0; }
  #landing > *{ position:relative; z-index:1 }

  /* chat */
  #chat-shell{ display:flex; flex-direction:column; height:calc(100dvh - 50px); }
  .chat-area{
    flex:1; padding:12px; overflow:auto; border-top:1px solid var(--panel-border);
    display:flex; flex-direction:column; gap:6px; align-items:flex-start;
    max-width:1100px; margin:0 auto;
  }
  .composer{ display:flex; gap:8px; padding:12px; border-top:1px solid var(--panel-border); background:var(--surface); position:sticky; bottom:0; align-items:center }
  .composer textarea{ flex:1; resize:none; min-height:38px; max-height:160px; border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text) }
  .send-btn{ border:0; padding:0 14px; border-radius:10px; cursor:pointer; background:var(--accent); color:#041; font-weight:600 }
  .send-btn i{ color:#fff }
  .send-btn:disabled{ opacity:.6; cursor:not-allowed }

  .msg{ display:inline-block; padding:10px 12px; margin:6px 0; border-radius:12px; max-width:72%; line-height:1.45; word-break:break-word; white-space:pre-wrap; background:rgba(255,255,255,0.06); color:var(--text); align-self:flex-start; text-align:left; }
  .msg-user{ align-self:flex-end; text-align:right; background:rgba(255,255,255,0.10); }
  .msg-assistant{ align-self:flex-start; text-align:left; background:rgba(0,0,0,0.18); }
  .msg-system{ align-self:center; text-align:center; background:rgba(255,0,0,0.05); }

  /* typing */
  .msg.typing{ opacity:0.95; background:rgba(255,255,255,0.02); min-width:90px; max-width:220px; display:flex; align-items:center; justify-content:center; padding:8px 12px; }
  .typing-dots{ display:inline-flex; gap:6px; align-items:center; }
  .typing-dots span{ width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,0.3); display:inline-block; opacity:0.3; transform:translateY(0); animation:dot 1s infinite ease-in-out; }
  .typing-dots span:nth-child(2){ animation-delay:0.18s }
  .typing-dots span:nth-child(3){ animation-delay:0.36s }
  @keyframes dot{ 0%{opacity:0.25; transform:translateY(0)} 50%{opacity:1; transform:translateY(-6px)} 100%{opacity:0.25; transform:translateY(0)} }

  .banner{ padding:8px 12px; text-align:center; font-size:13px; display:none }
  .banner.ok{ display:block; background:#063; color:#c7ffd9; border-bottom:1px solid #055 }
  .banner.warn{ display:block; background:#5a4600; color:#ffe9a8; border-bottom:1px solid #3d2f00 }
  .banner.err{ display:block; background:#5a0000; color:#ffd7d7; border-bottom:1px solid #3d0000 }

  #chat-lang-select{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.03); border-radius:8px; padding:6px 8px; font-size:14px }

  /* right-side theme toggle: upright vertical */
  #theme-side-toggle{
    position:fixed; right:12px; top:12px; z-index:9999;
    width:56px; height:140px;
    background:var(--surface); color:var(--text);
    border:1px solid rgba(0,0,0,0.06);
    border-bottom-left-radius:14px; border-bottom-right-radius:14px;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 8px 20px rgba(2,6,23,0.3);
    writing-mode:vertical-rl; text-orientation:upright;
    transform:none; font-size:12px; user-select:none;
  }
  #theme-side-toggle > .ts-text{ writing-mode:vertical-rl; text-orientation:upright; transform:none; display:block; text-align:center; font-weight:600; pointer-events:none; }
  #theme-side-toggle::after{ content:''; position:absolute; left:8px; right:8px; bottom:8px; height:34px; border-radius:18px; background:rgba(255,255,255,0.95); pointer-events:none; }
  .light-theme #theme-side-toggle::after{ background:rgba(10,12,16,0.92); }

  @media (max-width:900px){
    aside.sidebar{ display:none }
    #theme-side-toggle{ right:8px; top:8px; height:110px; width:48px; }
    #theme-side-toggle::after{ height:30px; left:6px; right:6px; bottom:6px; border-radius:15px; }
  }
  .sr-only{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden }
</style>
</head>
<body>

<div id="banner" class="banner"></div>

<!-- Side theme toggle -->
<button id="theme-side-toggle" aria-label="Toggle theme (side)" role="switch" tabindex="0">
  <span class="ts-text">Theme</span>
</button>

<div id="app" class="container" hidden>
  <aside class="sidebar" aria-label="Conversation history">
    <div class="title">Chat History</div>
    <button id="new-topic" class="btn" type="button">+ New Chat</button>
    <div id="history-list"></div>
    <div style="margin-top:8px">
      <a href="settings.html" class="btn" aria-label="Open settings">⚙️ Settings</a>
    </div>
  </aside>

  <main>
    <header class="topbar">
      <div class="topbar-inner" role="banner" aria-label="Top bar">
        <h1>VedSAAS</h1>
        <!-- no theme text in header -->
      </div>
    </header>

    <section id="landing">
      <div class="title">Start a new conversation</div>
      <div style="opacity:.8">Ask anything. I’ll reply in your language.</div>
      <div class="composer" aria-label="Landing composer">
        <textarea id="landing-input" placeholder="Type your first message..." rows="1" aria-label="Landing message input"></textarea>

        <label for="landing-chat-lang" class="sr-only">Chat language</label>
        <select id="landing-chat-lang" aria-label="Select chat language">
          <option value="Auto">Auto</option>
          <option value="en">English</option>
          <option value="hi">हिन्दी</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
        </select>

        <button id="landing-start" class="send-btn" type="button" aria-label="Start chat"><i class="fas fa-paper-plane"></i></button>
      </div>
      <div><button id="landing-open-history" class="btn" type="button">Open Previous Chats</button></div>
    </section>

    <section id="chat-shell" style="display:none; min-height:0;">
      <div id="chat-area" class="chat-area" aria-live="polite"></div>
      <div class="composer" role="region" aria-label="Chat composer">
        <textarea id="main-input" placeholder="Type your message..." rows="1" aria-label="Chat message input"></textarea>

        <label for="chat-lang-select" class="sr-only">Chat language</label>
        <select id="chat-lang-select" aria-label="Select chat language">
          <option value="Auto">Auto</option>
          <option value="en">English</option>
          <option value="hi">हिन्दी</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
        </select>

        <button id="send-btn" class="send-btn" type="button" disabled aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
      </div>
    </section>
  </main>
</div>

<button id="to-bottom" class="btn" style="position:fixed; right:16px; bottom:16px"><i class="fas fa-angle-down"></i> Latest</button>

<script>
/* API base */
if(!window.API_BASE){
  const m=document.querySelector('meta[name="ved-api-base"]')?.content?.trim()||'';
  window.API_BASE=(m?m:'/api').replace(/\/$/,'');
}

/* utils */
const $=(id)=>document.getElementById(id);
const esc=(s)=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
function banner(kind,msg){const b=$('banner');b.className='banner '+kind;b.textContent=msg;b.style.display='block';setTimeout(()=>b.style.display='none',2200);}

/* theme + lang */
const THEME_KEY='vedsaas_theme', LANG_KEY='vedsaas_chat_lang';
function applyTheme(t){ if(t==='light') document.documentElement.classList.add('light-theme'); else document.documentElement.classList.remove('light-theme'); }
function getSavedTheme(){ return localStorage.getItem(THEME_KEY)||'dark'; }
function setSavedTheme(t){ localStorage.setItem(THEME_KEY,t); applyTheme(t); }
function getSavedLang(){ return localStorage.getItem(LANG_KEY)||'Auto'; }
function setSavedLang(v){ localStorage.setItem(LANG_KEY,v); }

/* state */
let topics=[], currentTopicId=null, sending=false;

/* storage */
function save(){ try{ localStorage.setItem('ved_topics',JSON.stringify(topics)); localStorage.setItem('ved_current',currentTopicId||''); }catch{} }
function load(){ try{ topics=JSON.parse(localStorage.getItem('ved_topics')||'[]'); }catch{ topics=[]; } currentTopicId=localStorage.getItem('ved_current')||(topics[0]?.id||null); }

/* render */
function renderHistory(){
  const list=$('history-list'); list.innerHTML='';
  topics.forEach(t=>{
    const div=document.createElement('div');
    div.className='topic'+(t.id===currentTopicId?' active':'');
    const last=t.messages?.[t.messages.length-1]?.message||'';
    div.innerHTML=`<div style="font-weight:600">${esc(t.title||'Chat')}</div><div class="preview">${esc(last).slice(0,40)}</div>`;
    div.onclick=()=>goToChat(t.id);
    list.appendChild(div);
  });
}
function renderChat(){
  const area=$('chat-area'); const t=topics.find(x=>x.id===currentTopicId);
  if(!t){ $('landing').style.display='flex'; $('chat-shell').style.display='none'; return; }
  $('landing').style.display='none'; $('chat-shell').style.display='flex';
  area.innerHTML='';
  const header=document.createElement('div'); header.style.textAlign='center'; header.style.margin='6px 0 10px';
  header.innerHTML=`<strong>${esc(t.title||'New Chat')}</strong>`; area.appendChild(header);
  t.messages.forEach(m=>{
    const row=document.createElement('div'); row.className='msg '+(m.from==='user'?'msg-user':m.from==='assistant'?'msg-assistant':'msg-system'); row.textContent=m.message;
    area.appendChild(row);
  });
  area.scrollTop=area.scrollHeight;
}

/* ops */
function uid(){ return Math.random().toString(36).slice(2,9) }
function newTopic(title='New Chat'){ const id='t_'+Date.now(); topics.unshift({id,title,created_at:Date.now(),messages:[]}); currentTopicId=id; save(); renderHistory(); renderChat(); return id; }
function appendMessage(from,message){ const t=topics.find(x=>x.id===currentTopicId); if(!t) return; t.messages.push({id:uid(),from,message,timestamp:Date.now()}); save(); renderChat(); }
function goToChat(id){ currentTopicId=id; save(); renderHistory(); renderChat(); }

/* network */
async function api(path,body,{timeout=15000}={}){
  const ac=new AbortController(); const tm=setTimeout(()=>ac.abort(),timeout);
  try{
    const r=await fetch((window.API_BASE||'/api')+path,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{}), cache:'no-store', credentials:'omit', signal:ac.signal });
    const ct=(r.headers.get('content-type')||'').toLowerCase();
    if(!r.ok){ const txt=await r.text().catch(()=> ''); throw new Error(`HTTP ${r.status}${txt?': '+txt.slice(0,120):''}`); }
    return ct.includes('application/json')?r.json():r.text();
  } finally { clearTimeout(tm); }
}

/* reply normalization + fallback */
function pickReply(res){
  if(!res) return '';
  if(typeof res==='string') return res.trim();
  for(const k of ['reply','answer','message','text','output','result','response','bot']) if(typeof res[k]==='string'&&res[k].trim()) return res[k];
  if(Array.isArray(res.choices)&&res.choices[0]?.message?.content) return res.choices[0].message.content;
  const d=res.data;
  if(d){
    if(typeof d==='string'&&d.trim()) return d;
    for(const k of ['reply','answer','message','text','output','result','response']) if(typeof d[k]==='string'&&d[k].trim()) return d[k];
    if(Array.isArray(d.choices)&&d.choices[0]?.message?.content) return d.choices[0].message.content;
  }
  return '';
}
async function chatCall(payload){
  try{ return await api('/chat',payload); }
  catch(e){ const msg=String(e?.message||''); if(msg.includes('404')||msg.includes('405')) return await api('/ask',payload); throw e; }
}

/* send */
async function send(text){
  if(!text||sending) return;
  sending=true; $('send-btn').disabled=true;
  if(!currentTopicId) newTopic('New Chat');
  appendMessage('user',text);
  try{
    const res=await chatCall({message:text,prompt:text});
    const reply=pickReply(res);
    appendMessage('assistant',reply||'⚠️ Empty response from API');
  }catch(e){
    appendMessage('system','⚠️ '+(e.message||'Error'));
  }finally{
    sending=false; $('send-btn').disabled=false;
  }
}

/* wiring */
document.addEventListener('DOMContentLoaded',()=>{
  applyTheme(getSavedTheme());
  $('app').hidden=false;

  load(); renderHistory(); renderChat();

  // language selectors
  const landingLang=$('landing-chat-lang'); const mainLang=$('chat-lang-select');
  if(landingLang){ landingLang.value=getSavedLang(); landingLang.addEventListener('change',e=>{ setSavedLang(e.target.value); if(mainLang) mainLang.value=e.target.value; }); }
  if(mainLang){ mainLang.value=getSavedLang(); mainLang.addEventListener('change',e=>{ setSavedLang(e.target.value); if(landingLang) landingLang.value=e.target.value; }); }

  // landing send
  $('landing-start').onclick=()=>{
    const v=($('landing-input').value||'').trim(); if(!v) return;
    $('landing-input').value='';
    const lang=getSavedLang();
    const final=(lang&&lang!=='Auto'&&!v.startsWith('[lang:'))?`[lang:${lang}] ${v}`:v;
    send(final);
  };
  $('landing-input').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); $('landing-start').click(); }});
  $('landing-open-history').onclick=()=>{ if(currentTopicId) renderChat(); };

  // composer
  const main=$('main-input'), sendBtn=$('send-btn');
  const auto=(el)=>{ el.style.height='auto'; el.style.height=Math.min(160,el.scrollHeight)+'px'; };
  main.addEventListener('input',()=>{ auto(main); sendBtn.disabled=!main.value.trim(); });
  main.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
  sendBtn.onclick=()=>{
    const raw=main.value.trim(); if(!raw) return;
    const lang=getSavedLang();
    const toSend=(lang&&lang!=='Auto'&&!raw.startsWith('[lang:'))?`[lang:${lang}] ${raw}`:raw;
    main.value=''; sendBtn.disabled=true; send(toSend);
  };

  // new chat
  $('new-topic').onclick=()=>{ newTopic('New Chat'); renderChat(); $('main-input').focus(); };

  // bottom pill
  const area=$('chat-area'), pill=$('to-bottom');
  const isBottom=()=> area.scrollHeight - area.scrollTop - area.clientHeight < 8;
  const toggle=()=> pill.style.display = isBottom() ? 'none':'inline-flex';
  area.addEventListener('scroll',toggle); pill.onclick=()=>{ area.scrollTop=area.scrollHeight; toggle(); };
  toggle();
});
</script>

<script src="public/js/theme-side.js" defer></script>
<script src="public/js/assistant-typing.js" defer></script>
</body>
</html>
