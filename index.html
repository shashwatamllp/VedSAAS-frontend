<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="ved-api-base" content="/api">
<title>VedSAAS</title>
<link rel="icon" href="/favicon.ico"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="stylesheet" href="/public/css/theme-side.css"/>

<style>
  :root{ --bg:#0e0f14; --surface:#0f1720; --muted:#94a3b8; --text:#e9edf4; --accent:#2a7; --panel:#233 }
  :root{ color-scheme:dark }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;overflow:hidden}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--text)}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  .container{display:flex;height:100%}
  aside.sidebar{width:260px;border-right:1px solid var(--panel);padding:12px;display:flex;flex-direction:column;gap:10px;background:var(--surface)}
  .title{font-weight:700;margin:6px 0 8px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);color:var(--text);cursor:pointer}
  #history-list{overflow:auto;flex:1}
  .topic{padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .topic+.topic{margin-top:6px}
  .topic.active{background:var(--accent);color:#fff}

  main{flex:1;display:flex;flex-direction:column;min-width:0}
  .topbar{display:flex;align-items:center;justify-content:center;padding:10px 12px;background:var(--surface)}
  .topbar h1{margin:0;font-size:18px;letter-spacing:.5px}
  .topbar .right{margin-left:auto;display:flex;align-items:center;gap:10px}
  .badge{display:none;background:var(--accent);color:#041;padding:2px 8px;border-radius:999px;font-size:12px}

  /* Landing (no mid-scroll) */
  #landing{position:relative;display:flex;flex-direction:column;gap:12px;padding:16px;height:100%;overflow:hidden}
  #landing::before{content:"";position:absolute;inset:0;background:url("/public/image/logopic.png") center/60% no-repeat;opacity:.08;pointer-events:none}
  #landing>*{position:relative;z-index:1}

  /* Chat shell */
  #chat-shell{display:none;flex-direction:column;min-height:0;height:100%}
  .chat-area{
    flex:1;min-height:0;padding:12px;overflow:auto;
    display:flex;flex-direction:column;gap:6px;align-items:stretch;
    max-width:1100px;margin:0 auto;background:var(--bg);
  }
  .composer{
    position:sticky;bottom:0;z-index:10;
    display:flex;gap:8px;align-items:center;
    padding:12px;background:var(--surface);
  }
  .composer textarea{
    flex:1;resize:none;min-height:38px;max-height:160px;
    border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.05);
    background:transparent;color:var(--text)
  }
  .send-btn{border:0;padding:0 14px;border-radius:10px;cursor:pointer;background:var(--accent);color:#041;font-weight:600}
  .send-btn i{color:#fff}
  .send-btn:disabled{opacity:.6;cursor:not-allowed}

  /* Bubbles + labels */
  .msg{display:inline-block;padding:10px 12px;margin:4px 0;border-radius:12px;max-width:72%;line-height:1.45;word-break:break-word;white-space:pre-wrap;background:rgba(255,255,255,0.06);color:var(--text)}
  .msg-user{align-self:flex-end;background:rgba(255,255,255,0.10);text-align:right}
  .msg-assistant{align-self:flex-start;background:rgba(0,0,0,0.18)}
  .msg-system{align-self:center;background:#fee2e2;color:#7f1d1d;border:1px solid #fca5a5}

  .msg-block{display:flex;flex-direction:column;max-width:72%}
  .msg-block.left{align-self:flex-start;text-align:left}
  .msg-block.right{align-self:flex-end;text-align:right}
  .msg-label{font-size:12px;color:var(--muted);opacity:.9;margin:2px 4px}

  #to-bottom{position:fixed;right:16px;bottom:16px;z-index:999}
  @media (max-width:900px){ aside.sidebar{display:none} }
</style>
</head>
<body>

<div id="banner" class="banner" style="display:none"></div>

<div id="app" class="container" hidden>
  <aside class="sidebar" aria-label="Conversation history">
    <div class="title">Chat History</div>
    <button id="new-topic" class="btn" type="button">+ New Chat</button>
    <div id="history-list"></div>
    <div style="margin-top:8px">
      <a href="settings.html" class="btn" aria-label="Open settings">⚙️ Settings</a>
    </div>
  </aside>

  <main>
    <header class="topbar">
      <h1 id="app-title">VedSAAS</h1>
      <div class="right">
        <span id="user-display" style="opacity:.9"></span>
        <span id="api-ok-badge" class="badge">API OK</span>
      </div>
    </header>

    <section id="landing">
      <div class="title">Start a new conversation</div>
      <div style="opacity:.8">Ask anything. I’ll reply in your language.</div>
      <div class="composer" aria-label="Landing composer">
        <textarea id="landing-input" placeholder="Type your first message..." rows="1" aria-label="Landing message input"></textarea>
        <label for="landing-chat-lang" class="sr-only">Chat language</label>
        <select id="landing-chat-lang" aria-label="Select chat language">
          <option value="Auto">Auto</option><option value="en">English</option>
          <option value="hi">हिन्दी</option><option value="es">Español</option><option value="fr">Français</option>
        </select>
        <button id="landing-start" class="send-btn" type="button" aria-label="Start chat"><i class="fas fa-paper-plane"></i></button>
      </div>
      <div><button id="landing-open-history" class="btn" type="button">Open Previous Chats</button></div>
    </section>

    <section id="chat-shell">
      <div id="chat-area" class="chat-area" aria-live="polite"></div>
      <div class="composer" role="region" aria-label="Chat composer">
        <textarea id="main-input" placeholder="Type your message..." rows="1" aria-label="Chat message input"></textarea>
        <label for="chat-lang-select" class="sr-only">Chat language</label>
        <select id="chat-lang-select" aria-label="Select chat language">
          <option value="Auto">Auto</option><option value="en">English</option>
          <option value="hi">हिन्दी</option><option value="es">Español</option><option value="fr">Français</option>
        </select>
        <button id="send-btn" class="send-btn" type="button" disabled aria-label="Send message"><i class="fas fa-paper-plane"></i></button>
      </div>
    </section>
  </main>
</div>

<button id="to-bottom" class="btn"><i class="fas fa-angle-down"></i> Latest</button>
<button id="theme-side-toggle" aria-label="Toggle theme">
  <span class="ts-text">Theme</span>
</button>

<script>
if(!window.API_BASE){
  const m=document.querySelector('meta[name="ved-api-base"]')?.content?.trim()||'';
  window.API_BASE=(m?m:'/api').replace(/\/$/,'');
}

const $=(id)=>document.getElementById(id);
const esc=(s)=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* ---- Names ---- */
function displayName(){
  try{
    const u = JSON.parse(localStorage.getItem('ved_user')||'null');
    if (u && (u.name||u.username)) return u.name||u.username;
  }catch{}
  const nm = localStorage.getItem('ved_user_name');
  return nm && nm.trim() ? nm.trim() : 'Guest';
}
function nameForRole(role){
  if(role==='assistant') return 'VedSAAS';
  if(role==='system') return 'System';
  return displayName();
}
function setHeader(){
  const ud=$('user-display'); if(ud) ud.textContent=displayName();
  const h=$('app-title'); if(h) h.textContent='VedSAAS';
}

/* ---- State ---- */
const LANG_KEY='vedsaas_chat_lang';
function getSavedLang(){ return localStorage.getItem(LANG_KEY)||'Auto'; }

let topics=[], currentTopicId=null, sending=false;
function save(){ try{ localStorage.setItem('ved_topics',JSON.stringify(topics)); localStorage.setItem('ved_current',currentTopicId||''); }catch{} }
function load(){ try{ topics=JSON.parse(localStorage.getItem('ved_topics')||'[]'); }catch{ topics=[]; } currentTopicId=localStorage.getItem('ved_current')||(topics[0]?.id||null); }

/* ---- History ---- */
function renderHistory(){
  const list=$('history-list'); list.innerHTML='';
  topics.forEach(t=>{
    const div=document.createElement('div');
    div.className='topic'+(t.id===currentTopicId?' active':'');
    const last=t.messages?.[t.messages.length-1]?.message||'';
    div.innerHTML=`<div style="font-weight:600">${esc(t.title||'Chat')}</div><div class="preview">${esc(last).slice(0,40)}</div>`;
    div.onclick=()=>goToChat(t.id);
    list.appendChild(div);
  });
}

/* ---- Messages ---- */
function messageNode(role,text){
  const wrap=document.createElement('div');
  wrap.className='msg-block '+(role==='user'?'right':role==='assistant'?'left':'');
  const label=document.createElement('div'); label.className='msg-label'; label.textContent=nameForRole(role);
  const bubble=document.createElement('div'); bubble.className='msg '+(role==='user'?'msg-user':role==='assistant'?'msg-assistant':'msg-system'); bubble.textContent=text;
  wrap.append(label,bubble);
  return wrap;
}
function renderChat(){
  const area=$('chat-area'); const t=topics.find(x=>x.id===currentTopicId);
  if(!t){ $('landing').style.display='flex'; $('chat-shell').style.display='none'; return; }
  $('landing').style.display='none'; $('chat-shell').style.display='flex';
  area.innerHTML='';
  const header=document.createElement('div'); header.style.textAlign='center'; header.style.margin='6px 0 10px';
  header.innerHTML=`<strong>${esc(t.title||'New Chat')}</strong>`; area.appendChild(header);
  t.messages.forEach(m=> area.appendChild(messageNode(m.from,m.message)));
  area.scrollTop=area.scrollHeight;
}
function uid(){ return Math.random().toString(36).slice(2,9) }
function newTopic(title='New Chat'){ const id='t_'+Date.now(); topics.unshift({id,title,created_at:Date.now(),messages:[]}); currentTopicId=id; save(); renderHistory(); renderChat(); return id; }
function appendMessage(from,message){ const t=topics.find(x=>x.id===currentTopicId); if(!t) return; t.messages.push({id:uid(),from,message,timestamp:Date.now()}); save(); renderChat(); }
function goToChat(id){ currentTopicId=id; save(); renderHistory(); renderChat(); }

/* ---- API ---- */
async function api(path,body,{timeout=15000}={}){
  const ac=new AbortController(); const tm=setTimeout(()=>ac.abort(),timeout);
  try{
    const r=await fetch((window.API_BASE||'/api')+path,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{}),cache:'no-store',credentials:'omit',signal:ac.signal});
    const ct=(r.headers.get('content-type')||'').toLowerCase();
    if(!r.ok){ const txt=await r.text().catch(()=> ''); throw new Error(`HTTP ${r.status}${txt?': '+txt.slice(0,120):''}`); }
    return ct.includes('application/json')?r.json():r.text();
  } finally { clearTimeout(tm); }
}
function pickReply(res){
  if(!res) return '';
  if(typeof res==='string') return res.trim();
  for(const k of ['reply','answer','message','text','output','result','response','bot']){
    if(typeof res[k]==='string'&&res[k].trim()) return res[k];
  }
  if(Array.isArray(res.choices)&&res.choices[0]?.message?.content) return res.choices[0].message.content;
  const d=res.data;
  if(d){
    if(typeof d==='string'&&d.trim()) return d;
    for(const k of ['reply','answer','message','text','output','result','response']){
      if(typeof d[k]==='string'&&d.trim()) return d[k];
    }
    if(Array.isArray(d.choices)&&d.choices[0]?.message?.content) return d.choices[0].message.content;
  }
  return '';
}
async function chatCall(payload){
  try{ return await api('/chat',payload); }
  catch(e){ const msg=String(e?.message||''); if(msg.includes('404')||msg.includes('405')) return await api('/ask',payload); throw e; }
}
async function send(text){
  if(!text||sending) return;
  sending=true; $('send-btn').disabled=true;
  if(!currentTopicId) newTopic('New Chat');
  appendMessage('user',text);
  try{
    const res=await chatCall({message:text,prompt:text});
    const reply=pickReply(res);
    appendMessage('assistant',reply||'⚠️ Empty response from API');
  }catch(e){
    appendMessage('system','⚠️ '+(e.message||'Error'));
  }finally{
    sending=false; $('send-btn').disabled=false;
  }
}

/* ---- Boot ---- */
document.addEventListener('DOMContentLoaded',()=>{
  $('app').hidden=false;
  setHeader();

  load(); renderHistory(); renderChat();

  const landingLang=$('landing-chat-lang'); const mainLang=$('chat-lang-select');
  if(landingLang){ landingLang.value=getSavedLang(); landingLang.addEventListener('change',e=>{ localStorage.setItem('vedsaas_chat_lang',e.target.value); if(mainLang) mainLang.value=e.target.value; }); }
  if(mainLang){ mainLang.value=getSavedLang(); mainLang.addEventListener('change',e=>{ localStorage.setItem('vedsaas_chat_lang',e.target.value); if(landingLang) landingLang.value=e.target.value; }); }

  $('landing-start').onclick=()=>{
    const v=($('landing-input').value||'').trim(); if(!v) return;
    $('landing-input').value='';
    const lang=localStorage.getItem('vedsaas_chat_lang')||'Auto';
    const final=(lang&&lang!=='Auto'&&!v.startsWith('[lang:'))?`[lang:${lang}] ${v}`:v;
    send(final);
  };
  $('landing-input').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); $('landing-start').click(); }});
  $('landing-open-history').onclick=()=>{ if(currentTopicId) renderChat(); };

  const main=$('main-input'), sendBtn=$('send-btn');
  const auto=(el)=>{ el.style.height='auto'; el.style.height=Math.min(160,el.scrollHeight)+'px'; };
  main.addEventListener('input',()=>{ auto(main); sendBtn.disabled=!main.value.trim(); });
  main.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendBtn.click(); }});
  sendBtn.onclick=()=>{
    const raw=main.value.trim(); if(!raw) return;
    const lang=localStorage.getItem('vedsaas_chat_lang')||'Auto';
    const toSend=(lang&&lang!=='Auto'&&!raw.startsWith('[lang:'))?`[lang:${lang}] ${raw}`:raw;
    main.value=''; sendBtn.disabled=true; send(toSend);
  };

  $('new-topic').onclick=()=>{ newTopic('New Chat'); renderChat(); $('main-input').focus(); };

  const area=$('chat-area'), pill=$('to-bottom');
  const isBottom=()=> area.scrollHeight - area.scrollTop - area.clientHeight < 8;
  const toggle=()=> pill.style.display = isBottom() ? 'none':'inline-flex';
  area.addEventListener('scroll',toggle); pill.onclick=()=>{ area.scrollTop=area.scrollHeight; toggle(); };
  toggle();

  fetch((window.API_BASE||'/api')+'/health',{cache:'no-store'})
    .then(r=>r.json()).then(j=>{ if(j && (j.ok===true || j.status==='ok')){ const b=$('api-ok-badge'); if(b) b.style.display='inline-flex'; } })
    .catch(()=>{});
});
</script>

<script src="public/js/assistant-typing.js" defer></script>
</body>
</html>

