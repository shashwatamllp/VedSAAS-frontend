<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VedSAAS â€¢ Signup</title>
  <link rel="icon" href="./favicon.ico" />

  <!-- ðŸ” Provide API key here (or put it in localStorage.VED_API_KEY) -->
  <meta name="ved-api-key" content="super-long-random">

  <style>
    :root {
      --bg: #1e1e2f;
      --card: #2c2c3e;
      --ip: #3a3a4d;
      --ip-focus: #4a4a5f;
      --text: #fff;
      --muted: #b9bed1;
      --brand: #0078d4;
      --brand-2: #005ea2;
      --ok: #b7ffb7;
      --err: #ffd7d7;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }

    .auth-bg {
      position: fixed;
      inset: 0;
      background: url('./images/logopic.png') center/520px no-repeat;
      opacity: .06;
      pointer-events: none;
      z-index: 0;
    }

    .card {
      position: relative;
      z-index: 1;
      width: min(1100px, 98vw);
      max-height: 92vh;
      overflow: auto;
      scrollbar-gutter: stable;
      background: var(--card);
      border-radius: 14px;
      padding: 18px 20px 20px;
      box-shadow: 0 10px 38px rgba(0, 0, 0, .45);
    }

    h1 {
      font-size: 26px;
      text-align: center;
      margin-bottom: 4px
    }

    .sub {
      color: var(--muted);
      text-align: center;
      font-size: 14px;
      margin-bottom: 12px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px 14px
    }

    .span2 {
      grid-column: span 2
    }

    .span3 {
      grid-column: 1 / -1
    }

    label {
      display: block;
      font-size: 13px;
      color: #cfd2e2;
      margin: 2px 0 6px
    }

    .ip {
      width: 100%;
      padding: 11px 12px;
      border-radius: 10px;
      border: none;
      background: var(--ip);
      color: #fff;
      outline: none;
      font-size: 15px;
      transition: .15s background
    }

    .ip:focus {
      background: var(--ip-focus)
    }

    input[type="date"] {
      color-scheme: dark
    }

    .avatar-row {
      display: grid;
      grid-template-columns: 64px 1fr;
      gap: 12px;
      align-items: center
    }

    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #444 center/cover no-repeat
    }

    .hint {
      font-size: 12px;
      color: var(--muted)
    }

    .actions {
      display: block;
      margin-top: 6px
    }

    .btn {
      width: 100%;
      padding: 12px 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      color: #fff;
      background: var(--brand)
    }

    .btn:hover {
      background: var(--brand-2)
    }

    .msg {
      min-height: 18px;
      margin-top: 8px;
      text-align: center;
      font-size: 13px
    }

    .ok {
      color: var(--ok)
    }

    .err {
      color: var(--err)
    }

    .note {
      margin-top: 8px;
      text-align: center;
      color: #b5bbcf;
      font-size: 13px
    }

    .footer {
      position: relative;
      text-align: center;
      color: #9aa0b6;
      font-size: 12px;
      padding: 8px 0 0
    }

    @media (max-height:700px) {
      h1 {
        font-size: 24px
      }

      .sub {
        font-size: 13px
      }

      .ip {
        padding: 10px
      }
    }

    @media (max-width:1020px) {
      .grid {
        grid-template-columns: repeat(2, 1fr)
      }

      .span2,
      .span3 {
        grid-column: 1 / -1
      }
    }

    @media (max-width:640px) {
      .grid {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <div class="auth-bg"></div>

  <div class="card" id="card">
    <!-- Logo -->
    <div style="text-align: center; margin-bottom: 16px;">
      <img src="./public/image/logopic.png" alt="VedSAAS" style="height: 42px; width: auto;">
    </div>

    <h1>Signup with VedSAAS</h1>
    <p class="sub">Signup with VedSAAS India's First AI.</p>

    <form id="register-form" class="grid" autocomplete="off" novalidate>
      <div class="span3">
        <label for="name">Full Name</label>
        <input id="name" name="name" class="ip" placeholder="Your full name" required autocomplete="name" />
      </div>

      <div>
        <label for="email">Email</label>
        <input id="email" name="email" class="ip" type="email" placeholder="email@example.com" required
          autocomplete="email" />
      </div>
      <div>
        <label for="mobile">Mobile</label>
        <input id="mobile" name="mobile" class="ip" type="tel" placeholder="+91XXXXXXXXXX" required
          autocomplete="tel" />
      </div>
      <div>
        <label for="dob">Date of Birth</label>
        <input id="dob" name="dob" class="ip" type="date" required autocomplete="bday" />
      </div>

      <div>
        <label for="pw">Password</label>
        <input id="pw" name="password" class="ip" type="password" placeholder="Create password" required
          autocomplete="new-password" />
      </div>
      <div>
        <label for="cpw">Confirm</label>
        <input id="cpw" class="ip" type="password" placeholder="Re-enter password" required
          autocomplete="new-password" />
      </div>

      <div class="span3 avatar-row">
        <div id="preview" class="avatar"></div>
        <div>
          <label for="avatar">Profile picture</label>
          <input id="avatar" name="avatar" class="ip" type="file" accept="image/*" />
          <div class="hint">Max 1 MB â€¢ Square image looks best</div>
        </div>
      </div>

      <div class="span3 actions">
        <button class="btn" id="submit" type="submit">Register</button>
      </div>
    </form>

    <div id="msg" class="msg"></div>
    <p class="note">Already have an account? <a href="./login.html" style="color:#76b7ff">Login</a></p>
    <div class="footer">VedSAAS by Shashwatam Eco-Chic Creations LLP</div>
  </div>

  <script>
    // --------------------------------------------
    // API base (pinned for prod)
    // --------------------------------------------
    window.API_BASE = 'https://api.vedsaas.com';

    // --------------------------------------------
    // API key source
    // --------------------------------------------
    (function primeKey() {
      const metaKey = document.querySelector('meta[name="ved-api-key"]')?.content || '';
      if (metaKey && !localStorage.getItem('VED_API_KEY')) {
        localStorage.setItem('VED_API_KEY', metaKey);
      }
    })();
    const getApiKey = () => localStorage.getItem('VED_API_KEY') || '';

    // --------------------------------------------
    // tiny helpers
    // --------------------------------------------
    const $ = (id) => document.getElementById(id);
    const show = (t, ok = false) => { const m = $('msg'); m.className = 'msg ' + (ok ? 'ok' : 'err'); m.textContent = t || ''; };

    // avatar preview
    let avatarFile = null;
    $('avatar').addEventListener('change', e => {
      const f = e.target.files?.[0] || null;
      avatarFile = null;
      if (!f) { $('preview').style.backgroundImage = 'none'; return; }
      if (f.size > 1024 * 1024) { show('Image too large (max 1 MB)'); e.target.value = ''; return; }
      avatarFile = f;
      const rd = new FileReader();
      rd.onload = () => { $('preview').style.backgroundImage = `url('${rd.result}')`; };
      rd.readAsDataURL(f);
    });

    const validEmail = v => /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v || "");
    const validPhone = v => /^\+?\d{10,15}$/.test((v || "").replace(/\s/g, ""));

    async function parseResponse(r) {
      const ct = r.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await r.json().catch(() => ({})) : await r.text().catch(() => '');
      return { ct, data };
    }
    function friendlyError(r, dataStr) {
      if (r.status === 403 && /cacheable requests|cloudfront/i.test(dataStr || '')) {
        return 'Blocked by CDN: POST reached static S3 behavior. Check CloudFront /api/* behavior.';
      }
      return `HTTP ${r.status} ${r.statusText}${dataStr ? ': ' + dataStr : ''}`;
    }

    // --------------------------------------------
    // API wrappers â€” now always send X-API-Key
    // --------------------------------------------
    async function apiJSON(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-API-Key': getApiKey(),
        },
        body: JSON.stringify(body),
        mode: 'cors', cache: 'no-store', credentials: 'omit'
      });
      const { data } = await parseResponse(r);
      if (!r.ok) throw new Error(typeof data === 'string' ? friendlyError(r, data) : (data.error || data.message || friendlyError(r)));
      return data;
    }
    async function apiForm(url, formData) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'X-API-Key': getApiKey() },
        body: formData,
        mode: 'cors', cache: 'no-store', credentials: 'omit'
      });
      const { data } = await parseResponse(r);
      if (!r.ok) throw new Error(typeof data === 'string' ? friendlyError(r, data) : (data.error || data.message || friendlyError(r)));
      return data;
    }

    // --------------------------------------------
    // Submit
    // --------------------------------------------
    $('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = ($('name').value || '').trim();
      const email = ($('email').value || '').trim();
      const mobile = ($('mobile').value || '').trim();
      const dob = ($('dob').value || '').trim();
      const pw = $('pw').value || '';
      const cpw = $('cpw').value || '';

      if (!name) return show('Name required');
      if (!validEmail(email)) return show('Valid email required');
      if (!validPhone(mobile)) return show('Valid mobile required (10â€“15 digits)');
      if (!dob) return show('DOB required');
      if (pw.length < 6) return show('Password must be at least 6 characters');
      if (pw !== cpw) return show('Passwords do not match');

      const haveKey = !!getApiKey();
      if (!haveKey) {
        // keep it obvious in UI when key missing
        return show('API key missing. Please configure it.', false);
      }

      $('submit').disabled = true; show('');
      const base = window.API_BASE || '';

      // Build multipart (avatar-friendly)
      const fd = new FormData();
      fd.append('name', name);
      fd.append('email', email);
      fd.append('mobile', mobile);
      fd.append('dob', dob);
      fd.append('password', pw);
      if (avatarFile) fd.append('avatar', avatarFile);

      try {
        // Primary route
        try {
          await apiForm(`${base}/api/auth/register`, fd);
        } catch (e1) {
          // JSON fallback same endpoint
          try {
            await apiJSON(`${base}/api/auth/register`, { name, email, mobile, dob, password: pw });
          } catch (e2) {
            // Alt paths
            try {
              await apiForm(`${base}/api/register`, fd);
            } catch (e3) {
              await apiJSON(`${base}/api/register`, { name, email, mobile, dob, password: pw });
            }
          }
        }

        // Send OTP
        const identifier = email || mobile;
        try {
          await apiJSON(`${base}/api/auth/send-otp`, { identifier });
        } catch {
          await apiJSON(`${base}/api/send-otp`, { identifier });
        }

        // Stash a few bits for next screen
        try {
          localStorage.setItem('pendingIdentifier', identifier);
          localStorage.setItem('pendingName', name);
          localStorage.setItem('pendingDob', dob);
        } catch { }

        show('OTP sent. Redirectingâ€¦', true);
        setTimeout(() => { location.href = `./verify.html?who=${encodeURIComponent(identifier)}&sent=1`; }, 600);
      } catch (err) {
        show('Registration failed: ' + (err?.message || err));
        console.error('Register error:', err);
        $('submit').disabled = false;
      }
    });
  </script>
</body>

</html>