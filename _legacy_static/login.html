<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Force prod API base; JS will honor this -->
  <meta name="ved-api-base" content="https://api.vedsaas.com"/>
  <meta http-equiv="x-content-type-options" content="nosniff"/>
  <meta name="referrer" content="strict-origin-when-cross-origin"/>
  <title>VedSAAS • Login</title>
  <link rel="icon" href="./favicon.ico"/>

  <style>
    :root{
      --bg:#1e1e2f; --card:#2c2c3e; --ip:#3a3a4d; --ip-focus:#4a4a5f;
      --text:#fff; --muted:#b9bed1; --brand:#0078d4; --brand-2:#005ea2;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
      background:radial-gradient(1200px 600px at 50% -10%, #2a2a3b 0%, #1e1e2f 60%);
      color:var(--text); display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .card{
      position:relative; z-index:1; width:min(520px,94vw);
      background:var(--card); border-radius:14px; padding:28px 24px;
      box-shadow:0 12px 40px rgba(0,0,0,.45);
    }
    h1{font-size:26px; text-align:center; margin-bottom:6px}
    .sub{color:var(--muted); text-align:center; font-size:14px; margin-bottom:18px}
    label{display:block; font-size:13px; color:#cfd2e2; margin:10px 0 6px}
    .ip{width:100%; padding:12px 14px; border-radius:10px; border:none; background:var(--ip); color:#fff; outline:none; font-size:15px; transition:.15s background}
    .ip:focus{background:var(--ip-focus)}
    .actions{display:flex; gap:10px; margin-top:14px}
    .btn{
      width:100%; padding:12px 14px; border:none; cursor:pointer; border-radius:10px;
      background:var(--brand); color:#fff; font-weight:600; font-size:15px;
      box-shadow:0 3px 0 rgba(0,0,0,.25); transition:.15s transform,.15s background;
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .btn:hover{background:var(--brand-2)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn-secondary{background:#444}
    .msg{min-height:18px; margin-top:10px; text-align:center; font-size:13px}
    .ok{color:#b7ffb7} .err{color:#ffd7d7}
    .note{margin-top:12px; text-align:center; color:var(--muted); font-size:13px}
    .footer{position:fixed; left:0; right:0; bottom:10px; text-align:center; color:#9aa0b6; font-size:12px}
    @media (max-height:540px){ body{align-items:flex-start} .card{margin-top:30px} .footer{position:static; margin-top:14px} }
  </style>
</head>
<body>
    <!-- Navbar (Loaded Dynamically) -->
    <div id="navbar-placeholder"></div>
    <!-- Navbar (Loaded Dynamically) -->
    <div id='navbar-placeholder'></div>
  <div class="card" role="dialog" aria-labelledby="h1" aria-describedby="sub">
    <h1 id="h1">Login</h1>
    <p id="sub" class="sub">Verify your Email or Mobile number.</p>

    <label for="identifier">Email / Mobile</label>
    <input
      id="identifier"
      class="ip"
      type="text"
      inputmode="email"
      autocomplete="username email tel"
      placeholder="email@example.com  •  +91XXXXXXXXXX"
      autofocus
      aria-describedby="msg"
    />

    <div class="actions">
      <a class="btn btn-secondary" href="./register.html" rel="noopener">Create Account</a>
      <button id="send-btn" class="btn">Send OTP</button>
    </div>

    <div id="msg" class="msg" role="status" aria-live="polite"></div>
    <p class="note">
      New to VedSAAS? <a href="./register.html" style="color:#76b7ff" rel="noopener">Sign up here</a>.<br/>
      Already have an account? Enter your email/phone and tap <strong>Send OTP</strong>.
    </p>
  </div>

  <div class="footer">VedSAAS • Shashwatam Eco-Chie Creations LLP</div>

<script>
  // ---- API base resolver (meta -> vedsaas.com -> local dev) ----
  (function(){
    if (window.API_BASE) return;
    const metaBase = document.querySelector('meta[name="ved-api-base"]')?.content || '';
    const h = (location.hostname || '').toLowerCase();
    const origin = location.origin || '';
    if (metaBase) window.API_BASE = metaBase.replace(/\/$/, '');
    else if (h.endsWith('vedsaas.com')) window.API_BASE = (h === 'api.vedsaas.com') ? origin : 'https://api.vedsaas.com';
    else if (/:(8010|8011|8012)\b/.test(origin)) window.API_BASE = origin;
    else window.API_BASE = 'http://127.0.0.1:8010';
  })();

  // Bounce if already logged-in
  try { if (localStorage.getItem('token')) location.replace('./index.html'); } catch {}

  const $ = (id) => document.getElementById(id);
  const setMsg = (t, ok=false) => { const m = $('msg'); m.className = 'msg ' + (ok?'ok':'err'); m.textContent = t || ''; };

  // Light validation: email OR +countrycode digits (min 8)
  function looksLikeEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
  function looksLikePhone(v){ return /^\+?[0-9][0-9\-()\s]{7,}$/.test(v); }

  function mapHttpError(r, body){
    const text = typeof body === 'string' ? body : (body && body.error) || '';
    if (r.status === 401) return 'Unauthorized.';
    if (r.status === 403 && /cacheable requests|cloudfront/i.test(text)) {
      return 'Blocked by CDN: /api/* is not hitting API origin. Fix CloudFront behavior.';
    }
    if (r.status === 429) return 'Too many requests. Please try again later.';
    if (r.status >= 500) return 'Server error. Please try again.';
    return `HTTP ${r.status}${r.statusText ? ' ' + r.statusText : ''}${text ? ': ' + text : ''}`;
  }

  async function sendOtp() {
    const el = $('identifier');
    const val = (el.value || '').trim();
    if (!val) return setMsg('Enter email or mobile');
    if (!looksLikeEmail(val) && !looksLikePhone(val)) return setMsg('Enter a valid email or phone');

    const btn = $('send-btn');
    btn.disabled = true; setMsg('');

    // Abort after 15s
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), 15000);

    try {
      const resp = await fetch(`${window.API_BASE}/api/send-otp`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ identifier: val }),
        mode: 'cors',
        cache: 'no-store',
        credentials: 'omit',
        signal: ac.signal
      });

      const ct = resp.headers.get('content-type') || '';
      const body = ct.includes('application/json') ? await resp.json().catch(()=> ({})) : await resp.text().catch(()=> '');

      if (!resp.ok) return setMsg(mapHttpError(resp, body));

      if (!body || (body.ok !== undefined && !body.ok)) {
        return setMsg((body && body.error) || 'Failed to send OTP');
      }

      try { localStorage.setItem('pendingIdentifier', val); } catch {}
      setMsg('OTP sent. Redirecting…', true);
      setTimeout(() => { location.href = `./verify.html?who=${encodeURIComponent(val)}&sent=1`; }, 400);
    } catch (e) {
      setMsg(e?.name === 'AbortError' ? 'Network timeout. Try again.' : 'Network error. Try again.');
      console.error('send-otp error:', e);
    } finally {
      clearTimeout(t);
      btn.disabled = false;
    }
  }

  $('send-btn').addEventListener('click', sendOtp);
  $('identifier').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendOtp(); }});
</script>
    <!-- Component Loader -->
    <script src="/public/js/components.js"></script>
    </body>
</html>

