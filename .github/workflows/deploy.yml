name: Deploy Frontend to AWS S3 + CloudFront

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/src/**"
      - "**/public/**"
      - "**/package.json"
      - ".github/workflows/deploy.yml"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Find the folder that has package.json (e.g., frontend/, web/, app/, or repo root)
      - name: Locate frontend directory
        id: finddir
        run: |
          set -euo pipefail
          FRONTEND_DIR=""
          # prefer common names first
          for d in frontend web app client . ; do
            [ -f "$d/package.json" ] && FRONTEND_DIR="$d" && break || true
          done
          # fallback: search anywhere
          if [ -z "$FRONTEND_DIR" ]; then
            hits=$(git ls-files | grep -E '(^|/)(package.json)$' || true)
            for f in $hits; do
              d=$(dirname "$f"); [ "$d" = "." ] && d="."
              FRONTEND_DIR="$d"; break
            done
          fi
          if [ -z "$FRONTEND_DIR" ]; then
            echo "‚ùå No package.json found in repository."; exit 1
          fi
          echo "FRONTEND_DIR=$FRONTEND_DIR" >> "$GITHUB_ENV"
          echo "‚úÖ Using frontend dir: $FRONTEND_DIR"
          [ "$FRONTEND_DIR" != "." ] && ls -la "$FRONTEND_DIR"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install deps & Build
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          set -euo pipefail
          npm ci
          if npm run | grep -qE '^  build'; then
            npm run build
          else
            echo "‚ùå No 'build' script in package.json"; exit 1
          fi
          # Detect build dir: dist > build > out
          BUILD_DIR=""
          for d in dist build out; do
            [ -d "$d" ] && BUILD_DIR="$d" && break
          done
          [ -z "$BUILD_DIR" ] && { echo "‚ùå Build output not found (dist/build/out)."; ls -la; exit 1; }
          echo "BUILD_DIR=$BUILD_DIR" >> "$GITHUB_ENV"
          echo "‚úÖ Build output: $BUILD_DIR"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sanity check AWS + required secrets
        run: |
          set -euo pipefail
          : "${{ secrets.S3_BUCKET }}:?S3_BUCKET secret missing}"
          aws sts get-caller-identity >/dev/null

      - name: Upload to S3
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          set -euo pipefail
          echo "üöÄ Uploading $BUILD_DIR -> s3://${{ secrets.S3_BUCKET }}"
          aws s3 sync "$BUILD_DIR/" "s3://${{ secrets.S3_BUCKET }}" \
            --delete \
            --cache-control max-age=31536000,public \
            --exclude "index.html"
          aws s3 cp "$BUILD_DIR/index.html" "s3://${{ secrets.S3_BUCKET }}/index.html" \
            --cache-control no-store,max-age=0

      - name: Invalidate CloudFront (optional)
        if: success()
        run: |
          if [ -n "${{ secrets.CF_DIST_ID }}" ]; then
            aws cloudfront create-invalidation --distribution-id "${{ secrets.CF_DIST_ID }}" --paths "/*"
            echo "‚úÖ CloudFront invalidation triggered."
          else
            echo "‚ö†Ô∏è CF_DIST_ID not set; skipping."
          fi
