name: Deploy Frontend to AWS S3 + CloudFront

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.js"
      - "**/*.jsx"
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.css"
      - "**/*.html"
      - "**/package.json"
      - ".github/workflows/deploy.yml"

permissions:
  id-token: write
  contents: read

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: "20"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate frontend directory (where package.json lives)
        id: locate
        run: |
          set -euo pipefail
          # search up to 3 levels deep; adjust if needed
          FRONTEND_DIR="$(find . -maxdepth 3 -type f -name package.json -not -path "*/node_modules/*" -printf '%h\n' | head -n1 || true)"
          if [ -z "${FRONTEND_DIR}" ]; then
            echo "No package.json found in repository."
            exit 1
          fi
          echo "Found package.json in: ${FRONTEND_DIR}"
          echo "dir=${FRONTEND_DIR}" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ steps.locate.outputs.dir }}/package-lock.json"

      - name: Install deps & Build
        working-directory: ${{ steps.locate.outputs.dir }}
        run: |
          set -euo pipefail
          npm ci
          # safe build: if no build script, throw a helpful error
          if ! npm run | grep -qE '^  build'; then
            echo "No \"build\" script in package.json"
            cat package.json
            exit 1
          fi
          npm run build

      - name: Determine build output directory
        id: outdir
        run: |
          set -euo pipefail
          ROOT="${{ steps.locate.outputs.dir }}"
          if [ -d "$ROOT/dist" ]; then
            OUT="$ROOT/dist"
          elif [ -d "$ROOT/build" ]; then
            OUT="$ROOT/build"
          elif [ -d "$ROOT/out" ]; then
            OUT="$ROOT/out"
          else
            echo "Could not determine output folder (dist/build/out)."
            ls -la "$ROOT"
            exit 1
          fi
          echo "out=$OUT" >> "$GITHUB_OUTPUT"
          echo "Using output: $OUT"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          set -euo pipefail
          OUT="${{ steps.outdir.outputs.out }}"
          BUCKET="${{ secrets.S3_BUCKET }}"
          echo "ðŸš€ Syncing $OUT -> s3://$BUCKET"
          aws s3 sync "$OUT/" "s3://$BUCKET" --delete

      - name: Invalidate CloudFront cache (optional)
        if: success() && secrets.CF_DIST_ID != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ secrets.CF_DIST_ID }}" \
            --paths "/*"
          echo "âœ… CloudFront invalidation triggered."
