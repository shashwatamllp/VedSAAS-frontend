name: "üöÄ Deploy Static Frontend to S3 + CloudFront"

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-frontend
  cancel-in-progress: true

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  S3_BUCKET:  ${{ secrets.S3_BUCKET }}
  CF_DIST_ID: ${{ secrets.CF_DIST_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: "üß© Checkout"
        uses: actions/checkout@v4

      # - name: "üèóÔ∏è Build"
      #   run: npm ci && npm run build

      - name: "üîé Detect output folder safely"
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          for d in dist build out public .; do
            if [[ -d "$d" && -f "$d/index.html" ]]; then
              echo "out=$d" >> "$GITHUB_OUTPUT"
              echo "‚úÖ Using output folder: $d"
              exit 0
            fi
          done
          echo "‚ùå No folder with index.html found" >&2
          exit 1

      - name: "üîê Configure AWS (OIDC)"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: VedSAAS-Frontend-${{ github.run_id }}

      - name: "‚¨ÜÔ∏è Upload assets (js/css/images/fonts) with long cache"
        shell: bash
        env:
          OUT: ${{ steps.detect.outputs.out }}
        run: |
          set -euo pipefail
          aws s3 cp "$OUT" "s3://${S3_BUCKET}/" --recursive \
            --exclude "*" --include "*.js" \
            --content-type "application/javascript; charset=utf-8" \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive "REPLACE" --only-show-errors
          aws s3 cp "$OUT" "s3://${S3_BUCKET}/" --recursive \
            --exclude "*" --include "*.css" \
            --content-type "text/css; charset=utf-8" \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive "REPLACE" --only-show-errors
          aws s3 cp "$OUT" "s3://${S3_BUCKET}/" --recursive \
            --exclude "*" --include "*.map" --include "*.json" \
            --content-type "application/json; charset=utf-8" \
            --cache-control "public, max-age=31536000, immutable" \
            --metadata-directive "REPLACE" --only-show-errors
          aws s3 cp "$OUT" "s3://${S3_BUCKET}/" --recursive \
            --exclude "*" \
            --include "*.png" --include "*.jpg" --include "*.jpeg" --include "*.gif" --include "*.webp" --include "*.svg" \
            --include "*.woff" --include "*.woff2" --include "*.ttf" --include "*.otf" \
            --include "*.ico" --include "*.txt" --include "*.webmanifest" \
            --cache-control "public, max-age=31536000, immutable" \
            --only-show-errors

      - name: "‚¨ÜÔ∏è Upload HTML (no-cache)"
        shell: bash
        env:
          OUT: ${{ steps.detect.outputs.out }}
        run: |
          set -euo pipefail
          aws s3 cp "$OUT" "s3://${S3_BUCKET}/" --recursive \
            --exclude "*" --include "*.html" \
            --content-type "text/html; charset=utf-8" \
            --cache-control "no-cache, no-store, must-revalidate, max-age=0" \
            --metadata-directive "REPLACE" --only-show-errors

      - name: "üßπ Prune removed files"
        shell: bash
        env:
          OUT: ${{ steps.detect.outputs.out }}
        run: |
          set -euo pipefail
          aws s3 sync "$OUT" "s3://${S3_BUCKET}/" \
            --delete \
            --exclude "*" \
            --include "*.js" --include "*.css" --include "*.map" --include "*.json" \
            --include "*.png" --include "*.jpg" --include "*.jpeg" --include "*.gif" --include "*.webp" --include "*.svg" \
            --include "*.woff" --include "*.woff2" --include "*.ttf" --include "*.otf" \
            --include "*.ico" --include "*.txt" --include "*.webmanifest" \
            --only-show-errors
          aws s3 sync "$OUT" "s3://${S3_BUCKET}/" \
            --delete --exclude "*" --include "*.html" \
            --only-show-errors

      - name: "üåê CloudFront Invalidate (HTML first)"
        if: ${{ env.CF_DIST_ID != '' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${CF_DIST_ID}" \
            --paths "/index.html" "/*.html"
