name: Deploy Frontend to AWS S3 + CloudFront

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write   # OIDC ke liye zaroori
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # (Optional) Build step â€” agar React/Vite hai to rakho, warna hata do
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install + Build (skip if no package.json)
        run: |
          if [ -f package.json ]; then
            npm ci
            if npm run | grep -q "build"; then npm run build; else echo "No build script"; fi
          else
            echo "No package.json; skipping build"
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region:     ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Select deploy folder
        id: pick
        run: |
          if [ -d "dist" ]; then echo "dir=dist" >> $GITHUB_OUTPUT; else echo "dir=." >> $GITHUB_OUTPUT; fi

      - name: Deploy to S3
        run: |
          echo "Syncing ${{ steps.pick.outputs.dir }} -> s3://${{ secrets.S3_BUCKET }}"
          aws s3 sync "${{ steps.pick.outputs.dir }}" "s3://${{ secrets.S3_BUCKET }}" \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "README.md" \
            --exclude "Dockerfile.frontend.sample"

      - name: Invalidate CloudFront
        if: ${{ success() && secrets.CF_DIST_ID != '' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CF_DIST_ID }} \
            --paths "/*"
