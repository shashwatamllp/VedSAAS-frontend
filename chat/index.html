<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Assistant | VedSAAS</title>

  <!-- Design System -->
  <link rel="stylesheet" href="/public/css/civilization.css">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Markdown Support -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <style>
    /* --- CHAT SPECIFIC OVERRIDES --- */
    :root {
      --sidebar-width: 280px;
      --header-height: 60px;
      --input-area-height: auto;
    }

    body {
      overflow: hidden;
      /* Prevent body scroll, handle in containers */
      display: flex;
      height: 100vh;
      background: var(--bg-void);
    }

    /* --- LAYOUT --- */
    #app-container {
      display: flex;
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* --- SIDEBAR --- */
    #sidebar {
      width: var(--sidebar-width);
      background: rgba(10, 10, 15, 0.8);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      height: 100%;
    }

    .sidebar-header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid var(--border-subtle);
      gap: 12px;
    }

    .sidebar-brand {
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.1rem;
    }

    .new-chat-btn {
      margin: 20px;
      padding: 12px;
      background: var(--accent-cyan);
      color: #000;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .new-chat-btn:hover {
      transform: scale(1.02);
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px;
    }

    .history-item {
      padding: 12px;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    .history-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .history-item.active {
      background: rgba(0, 240, 255, 0.1);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 240, 255, 0.2);
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid var(--border-subtle);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s;
    }

    .nav-item:hover {
      color: var(--text-primary);
    }

    /* --- MAIN CHAT AREA --- */
    #main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      background: var(--bg-deep);
      height: 100%;
      overflow: hidden;
    }

    /* HEADER */
    .chat-header {
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: rgba(10, 10, 15, 0.6);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-subtle);
      z-index: 10;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .chat-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      transition: color 0.2s;
    }

    .icon-btn:hover {
      color: var(--text-primary);
    }

    /* MESSAGES */
    #message-stream {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }

    .message {
      display: flex;
      gap: 16px;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-purple);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .message.user .avatar {
      background: var(--text-secondary);
    }

    .message.bot .avatar {
      background: var(--gradient-glow);
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 1rem;
      line-height: 1.6;
      position: relative;
      max-width: 85%;
    }

    .message.user .bubble {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border-top-right-radius: 2px;
    }

    .message.bot .bubble {
      background: transparent;
      color: var(--text-primary);
      padding-left: 0;
    }

    /* MARKDOWN STYLES */
    .bubble pre {
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .bubble code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
    }

    .bubble p {
      margin-bottom: 10px;
    }

    .bubble p:last-child {
      margin-bottom: 0;
    }

    /* INPUT AREA */
    #input-area {
      padding: 24px;
      background: var(--bg-deep);
      /* Opaque background to cover messages */
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .input-container {
      max-width: 800px;
      width: 100%;
      position: relative;
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      display: flex;
      align-items: flex-end;
      padding: 12px;
      gap: 12px;
      transition: border-color 0.2s;
    }

    .input-container:focus-within {
      border-color: var(--accent-cyan);
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-ui);
      font-size: 1rem;
      resize: none;
      max-height: 200px;
      padding: 4px 0;
      line-height: 1.5;
    }

    textarea::placeholder {
      color: var(--text-secondary);
    }

    .send-btn {
      background: var(--accent-cyan);
      color: #000;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .send-btn:hover {
      transform: scale(1.05);
    }

    .send-btn:disabled {
      background: var(--text-secondary);
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stop-btn {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      display: none;
      /* JS toggles this */
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
    }

    /* --- MOBILE RESPONSIVE (Strict < 1024px) --- */
    @media (max-width: 1024px) {
      #sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
      }

      #sidebar.open {
        transform: translateX(0);
      }

      .mobile-menu-btn {
        display: block;
      }

      /* Overlay when sidebar open */
      #sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 90;
        display: none;
      }

      #sidebar-overlay.active {
        display: block;
      }

      #input-area {
        padding: 12px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
      }

      #message-stream {
        padding-bottom: 100px;
      }

      /* Space for fixed input */
    }
  </style>
</head>

<body>

  <div id="app-container">

    <!-- SIDEBAR -->
    <div id="sidebar-overlay"></div>
    <aside id="sidebar">
      <div class="sidebar-header">
        <img src="/public/image/logopic.png" alt="Logo" width="24">
        <div class="sidebar-brand">VedSAAS</div>
      </div>

      <div class="new-chat-btn" id="btn-new-chat">
        <i class="fas fa-plus"></i> New Chat
      </div>

      <div class="history-list" id="history-list">
        <!-- Javascript will populate this -->
      </div>

      <div class="sidebar-footer">
        <div class="nav-item" onclick="window.location.href='/'">
          <i class="fas fa-home"></i> Back to Home
        </div>
        <div class="nav-item" id="btn-settings">
          <i class="fas fa-cog"></i> Settings
        </div>
        <div class="nav-item" id="btn-logout" style="color: #ff4d4d;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </div>
      </div>
    </aside>

    <!-- MAIN CHAT -->
    <main id="main-chat">
      <header class="chat-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <button class="mobile-menu-btn" id="btn-menu"><i class="fas fa-bars"></i></button>
          <div class="chat-title">AI Assistant</div>
        </div>
        <div class="header-actions">
          <button class="icon-btn" id="btn-clear" title="Clear Chat"><i class="fas fa-trash-alt"></i></button>
        </div>
      </header>

      <div id="message-stream">
        <!-- Welcome Message -->
        <div class="message bot">
          <div class="avatar"><i class="fas fa-robot"></i></div>
          <div class="bubble">
            <p>Hello! I am VedSAAS, your AI assistant. How can I help you today?</p>
          </div>
        </div>
      </div>

      <!-- INPUT AREA -->
      <div id="input-area">
        <button class="stop-btn" id="btn-stop"><i class="fas fa-stop"></i> Stop Generating</button>
        <div class="input-container">
          <textarea id="chat-input" placeholder="Type your message..." rows="1"></textarea>
          <button class="send-btn" id="btn-send"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </main>
  </div>

  <!-- LOGIC -->
  <script>
    // --- CONSTANTS & STATE ---
    const API_ENDPOINT = '/engine/ask'; // Using existing backend
    const HISTORY_KEY = 'vedsaas_chat_history';
    const AUTH_TOKEN_KEY = 'token'; // Matching existing auth

    let state = {
      isSidebarOpen: false,
      isGenerating: false,
      currentChatId: Date.now().toString(),
      history: [], // List of {id, title, timestamp}
      messages: [], // Current conversation messages
      controller: null // For aborting fetch
    };

    // --- DOM ELEMENTS ---
    const els = {
      sidebar: document.getElementById('sidebar'),
      overlay: document.getElementById('sidebar-overlay'),
      input: document.getElementById('chat-input'),
      sendBtn: document.getElementById('btn-send'),
      stopBtn: document.getElementById('btn-stop'),
      msgStream: document.getElementById('message-stream'),
      historyList: document.getElementById('history-list'),
      menuBtn: document.getElementById('btn-menu'),
      newChatBtn: document.getElementById('btn-new-chat'),
      clearBtn: document.getElementById('btn-clear'),
      logoutBtn: document.getElementById('btn-logout')
    };

    // --- INIT ---
    function init() {
      checkAuth();
      loadHistory();
      setupEventListeners();
      // Responsive check
      if (window.innerWidth >= 1024) {
        // Web: sidebar always open, no overlay
        state.isSidebarOpen = true;
      }
    }

    function checkAuth() {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (!token) {
        // User spec: "Session expired -> force logout"
        window.location.href = '/login.html'; // Or wherever login is
      }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
      els.menuBtn.addEventListener('click', toggleSidebar);
      els.overlay.addEventListener('click', closeSidebar);

      els.input.addEventListener('input', autoResizeInput);
      els.input.addEventListener('keydown', handleEnterKey);

      els.sendBtn.addEventListener('click', sendMessage);
      els.stopBtn.addEventListener('click', stopGeneration);

      els.newChatBtn.addEventListener('click', startNewChat);
      els.clearBtn.addEventListener('click', clearCurrentChat);
      els.logoutBtn.addEventListener('click', logout);
    }

    // --- SIDEBAR LOGIC ---
    function toggleSidebar() {
      state.isSidebarOpen = !state.isSidebarOpen;
      updateSidebarUI();
    }

    function closeSidebar() {
      if (window.innerWidth < 1024) {
        state.isSidebarOpen = false;
        updateSidebarUI();
      }
    }

    function updateSidebarUI() {
      if (state.isSidebarOpen) {
        els.sidebar.classList.add('open');
        if (window.innerWidth < 1024) els.overlay.classList.add('active');
      } else {
        els.sidebar.classList.remove('open');
        els.overlay.classList.remove('active');
      }
    }

    // --- INPUT LOGIC ---
    function autoResizeInput() {
      els.input.style.height = 'auto';
      els.input.style.height = Math.min(els.input.scrollHeight, 200) + 'px';
    }

    function handleEnterKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent newline
        sendMessage();
      }
    }

    // --- CHAT LOGIC ---
    async function sendMessage() {
      const text = els.input.value.trim();
      if (!text || state.isGenerating) return;

      // 1. UI Updates
      addMessageToUI('user', text);
      els.input.value = '';
      els.input.style.height = 'auto';
      setGeneratingState(true);

      // 2. Prepare Payload
      // Using logic from old chat/index.html to ensure backend compatibility
      const payload = {
        message: text,
        context: { from: 'web_frontend', timezone: Intl.DateTimeFormat().resolvedOptions().timeZone }
      };

      // 3. Create formatting bubble for AI
      const aiBubbleId = addMessageToUI('bot', '...', true); // true = isLoading

      try {
        // AbortController for Stop functionality
        state.controller = new AbortController();

        const token = localStorage.getItem(AUTH_TOKEN_KEY);
        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? 'Bearer ' + token : ''
          },
          body: JSON.stringify(payload),
          signal: state.controller.signal
        });

        if (res.status === 401) {
          handleAuthError();
          return;
        }

        if (!res.ok) throw new Error('Server error');

        const data = await res.json();
        // Handling different backend response formats
        const reply = data.response || data.message || "I received your message but have no response.";

        updateAiMessage(aiBubbleId, reply);
        saveMessageToHistory('user', text);
        saveMessageToHistory('bot', reply);
        updateHistoryList(text); // Update sidebar title if new

      } catch (err) {
        if (err.name === 'AbortError') {
          updateAiMessage(aiBubbleId, '_Generation stopped._');
        } else {
          updateAiMessage(aiBubbleId, '**Error:** Something went wrong. Please try again.');
        }
      } finally {
        setGeneratingState(false);
        state.controller = null;
      }
    }

    function stopGeneration() {
      if (state.controller) {
        state.controller.abort();
      }
    }

    function setGeneratingState(isGen) {
      state.isGenerating = isGen;
      els.sendBtn.disabled = isGen;
      els.stopBtn.style.display = isGen ? 'flex' : 'none';
    }

    // --- UI RENDERING ---
    function addMessageToUI(role, content, isLoading = false) {
      const div = document.createElement('div');
      div.className = `message ${role === 'user' ? 'user' : 'bot'}`;
      const id = 'msg-' + Date.now();
      div.id = id;

      let bubbleContent = '';
      if (isLoading) {
        bubbleContent = '<i class="fas fa-circle-notch fa-spin"></i> Thinking...';
      } else {
        bubbleContent = role === 'user' ? escapeHtml(content) : renderMarkdown(content);
      }

      div.innerHTML = `
                <div class="avatar">
                    <i class="fas fa-${role === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="bubble">${bubbleContent}</div>
            `;

      els.msgStream.appendChild(div);
      scrollToBottom();
      return id;
    }

    function updateAiMessage(id, content) {
      const msgDiv = document.getElementById(id);
      if (msgDiv) {
        const bubble = msgDiv.querySelector('.bubble');
        bubble.innerHTML = renderMarkdown(content);
        // Highlight code blocks
        bubble.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      }
      scrollToBottom();
    }

    function scrollToBottom() {
      els.msgStream.scrollTop = els.msgStream.scrollHeight;
    }

    // --- HELPERS ---
    function renderMarkdown(text) {
      // Basic markdown configuration using marked.js
      return marked.parse(text);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/\n/g, '<br>');
    }

    function startNewChat() {
      state.currentChatId = Date.now().toString();
      state.messages = [];
      els.msgStream.innerHTML = `
                <div class="message bot">
                    <div class="avatar"><i class="fas fa-robot"></i></div>
                    <div class="bubble"><p>New chat started. How can I help?</p></div>
                </div>
            `;
      if (window.innerWidth < 1024) closeSidebar();
    }

    function clearCurrentChat() {
      if (confirm("Are you sure you want to clear this chat?")) {
        startNewChat();
      }
    }

    function logout() {
      localStorage.removeItem(AUTH_TOKEN_KEY);
      window.location.reload();
    }

    function handleAuthError() {
      alert("Session expired. Please login again.");
      logout();
    }

    // --- MOCK HISTORY PERSISTENCE (Browser LocalStorage) ---
    function loadHistory() {
      // In a real app, this would fetch from /chat/history
      const saved = localStorage.getItem(HISTORY_KEY);
      if (saved) {
        state.history = JSON.parse(saved);
        renderHistoryList();
      }
    }

    function saveMessageToHistory(role, content) {
      // Mock persistence - strictly for demo as backend persistence wasn't strictly detailed beyond "same endpoints"
      // We assume backend handles message storage on /send, but we store minimal local history for Sidebar
    }

    function updateHistoryList(firstMessage) {
      // Check if current chat exists
      const existing = state.history.find(h => h.id === state.currentChatId);
      if (!existing) {
        const newChat = {
          id: state.currentChatId,
          title: firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : ''),
          timestamp: Date.now()
        };
        state.history.unshift(newChat); // Add to top
        localStorage.setItem(HISTORY_KEY, JSON.stringify(state.history));
        renderHistoryList();
      }
    }

    function renderHistoryList() {
      els.historyList.innerHTML = state.history.map(chat => `
                <div class="history-item ${chat.id === state.currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    ${escapeHtml(chat.title)}
                </div>
            `).join('');
    }

    // Expose loadChat for onclick
    window.loadChat = function (id) {
      state.currentChatId = id;
      // In real app, fetch messages for this ID. 
      // Here we just clear for demo as we don't have full history API ready
      startNewChat();
      renderHistoryList(); // Re-render to highlight active
    };

    // Run
    init();

  </script>
</body>

</html>